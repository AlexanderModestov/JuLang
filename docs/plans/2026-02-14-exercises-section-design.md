# Дизайн раздела "Упражнения"

Дата: 2026-02-14

## Цель

Наполнить раздел "Упражнения" готовыми заданиями по грамматическим правилам, привязанными к уровню изучения языка. Упражнения хранятся в JSON (без AI-генерации), с полным трекингом прогресса.

## Типы упражнений

### 1. Multiple choice (выбор варианта)
Предложение с пропуском + 4 варианта ответа.

```json
{
  "id": "a1-def-articles-mc-01",
  "topicId": "definite-articles",
  "level": "A1",
  "type": "multiple_choice",
  "question": "Je vais à ___ école.",
  "options": ["le", "la", "l'", "les"],
  "correctAnswer": "l'",
  "explanation": "Перед гласной используется l'"
}
```

### 2. Fill blank (заполни пропуск)
Предложение с пропуском + текстовое поле ввода. Без подсказок.

```json
{
  "id": "a1-def-articles-fb-01",
  "topicId": "definite-articles",
  "level": "A1",
  "type": "fill_blank",
  "question": "___ chat est noir.",
  "correctAnswer": "Le",
  "explanation": "Le — определённый артикль мужского рода"
}
```

### 3. Translate (перевод с русского)
Русское предложение + текстовое поле для перевода.

```json
{
  "id": "a1-def-articles-tr-01",
  "topicId": "definite-articles",
  "level": "A1",
  "type": "translate",
  "question": "Кошка чёрная.",
  "correctAnswer": "La chatte est noire.",
  "acceptableAnswers": ["Le chat est noir."],
  "explanation": "La — артикль ж.р., le — м.р."
}
```

Проверка нечувствительна к регистру и акцентам. Поле `acceptableAnswers` содержит допустимые альтернативы.

### 4. Matching (сопоставление грамматических конструкций)
Два столбца с грамматическими элементами для сопоставления. Не "слово-перевод", а грамматические связи: спряжения глаголов, формы, конструкции.

```json
{
  "id": "a1-etre-avoir-ma-01",
  "topicId": "etre-avoir-present",
  "level": "A1",
  "type": "matching",
  "instruction": "Соедините местоимение с формой глагола être",
  "pairs": [
    { "left": "je", "right": "suis" },
    { "left": "tu", "right": "es" },
    { "left": "il/elle", "right": "est" },
    { "left": "nous", "right": "sommes" }
  ]
}
```

Примеры matching по языкам:
- **Французский**: местоимение + форма глагола, артикль + существительное, подлежащее + причастие
- **Английский**: инфинитив + 2-я/3-я формы неправильных глаголов, местоимение + форма to be, условие + результат

## Объём данных

| Язык | Тем | Заданий на тему | Всего |
|------|-----|-----------------|-------|
| Французский | 31 | 20 (~5 на тип) | ~620 |
| Английский | 28 | 20 (~5 на тип) | ~560 |
| **Итого** | **59** | | **~1180** |

### Французский — темы по уровням

| Уровень | Кол-во | Темы |
|---------|--------|------|
| A1 | 7 | Определённые артикли, неопределённые артикли, être/avoir, глаголы -er, отрицание, личные местоимения, согласование прилагательных |
| A2 | 7 | Passé composé (avoir), passé composé (être), imparfait, местоимения COD, местоимения COI, возвратные глаголы, futur simple |
| B1 | 6 | Subjonctif présent, conditionnel présent, относительные местоимения, plus-que-parfait, страдательный залог, герундий |
| B2 | 5 | Условные с si, косвенная речь, subjonctif passé, conditionnel passé, futur antérieur |
| C1 | 4 | Passé simple, subjonctif imparfait, ne explétif |
| C2 | 2 | Литературные времена, стилистическая инверсия |

### Английский — темы по уровням

| Уровень | Кол-во | Темы |
|---------|--------|------|
| A1 | 7 | Определённый артикль, неопределённые артикли, to be, Present Simple, личные местоимения, отрицание, порядок прилагательных |
| A2 | 6 | Present Continuous, Past Simple, Present Perfect, объектные местоимения, притяжательные прилагательные, future will |
| B1 | 6 | Сравнительная степень, превосходная степень, relative clauses, Past Continuous, 1st conditional, passive voice |
| B2 | 5 | 2nd conditional, 3rd conditional, reported speech, Past Perfect, Future Perfect |
| C1 | 2 | Инверсия, subjunctive |
| C2 | 2 | Cleft sentences, эллипсис |

## Файлы данных

```
src/data/exercises-fr.json    — ~620 заданий для французского
src/data/exercises-en.json    — ~560 заданий для английского
```

Идентификаторы заданий: `{level}-{topicId}-{type}-{number}`, например `a1-def-articles-mc-01`.

## Экран "Упражнения" — главный вход

### Верхняя часть — быстрый старт
- Заголовок: "Упражнения" + текущий уровень (напр. "A1")
- Крупная кнопка "Начать сессию" — микс из 10 заданий по темам текущего уровня
- Краткая статистика под кнопкой: "Решено 45/140 заданий · 78% правильно"

### Нижняя часть — выбор тем
- Заголовок: "Выбрать тему"
- Фильтр-чипсы по уровням: A1, A2, B1, B2, C1, C2 (по умолчанию — текущий уровень)
- Плоский список тем, для каждой:
  - Название темы
  - Мини прогресс-бар (решено X/20)
  - Процент правильных
  - Чекбокс для мультивыбора
- Кнопка "Начать по выбранным темам" (активна при >= 1 выбранной)

## Экран сессии

### Общая обёртка
- Прогресс-бар сверху
- Счётчик "3/10"
- Кнопка выхода

### Multiple choice
- Предложение с пропуском
- 4 кнопки-варианта вертикально
- Правильный → зелёная подсветка + объяснение (1.5 сек)
- Неправильный → красная у выбранного + зелёная у правильного + объяснение

### Fill blank
- Предложение с пропуском
- Текстовое поле + кнопка "Проверить"
- Проверка нечувствительна к регистру и акцентам
- Результат: зелёная/красная рамка + объяснение + правильный ответ при ошибке

### Translate
- Русское предложение
- Текстовое поле + кнопка "Проверить"
- Сравнение с correctAnswer и acceptableAnswers
- Показываем правильный вариант + объяснение

### Matching
- Два столбца в случайном порядке
- Нажатие слева → нажатие справа → образуется пара
- Правильная пара → зеленеет и "уходит"
- Неправильная → красная вспышка, разъединение
- Задание решено когда все пары собраны. Правильно = ни одной ошибки

### Завершение сессии
- Экран результатов: X/10 правильно (Y%)
- Кнопки: "На главную" и "Ещё раз"

## Логика формирования сессии

### Сессия-микс (по текущему уровню)
1. Берём все темы текущего уровня
2. Из каждой темы приоритет: нерешённые → ранее ошибочные → давно не решавшиеся (> 7 дней) → случайные
3. Перемешиваем, берём 10 штук
4. Балансируем типы (не больше 3-4 одного типа подряд)

### Сессия по выбранным темам
1. Берём задания только из выбранных тем
2. Та же логика приоритетов
3. Берём 10 штук (или все, если меньше 10)

## Трекинг прогресса

### Структура данных (IndexedDB / Dexie)

```typescript
interface ExerciseProgress {
  id: string
  odIndex: string          // compositeKey: userId_exerciseId
  odUserId: string
  exerciseId: string       // "a1-def-articles-mc-01"
  topicId: string          // "definite-articles"
  level: string            // "A1"
  solved: boolean          // решено хотя бы раз правильно
  attempts: number         // сколько раз встречалось
  correctCount: number     // сколько раз правильно
  lastAttempt: Date
  lastCorrect: boolean     // последний результат
}
```

### Агрегация по теме (экран выбора тем)
- Прогресс = solved / total (напр. 14/20)
- Точность = correctCount / attempts
- Тема "пройдена" когда все 20 заданий solved

### Агрегация по уровню (главный экран)
- Общий прогресс = сумма solved по всем темам уровня
- Общая точность = среднее по всем попыткам уровня

### Хранение
- Локально в Dexie (IndexedDB)
- Синхронизация с Supabase через существующий migrationService при авторизации

## Компоненты и файлы

### Новые файлы

```
src/data/exercises-fr.json              — 620 заданий для французского
src/data/exercises-en.json              — 560 заданий для английского

src/components/Exercises/
  ExercisesScreen.tsx                   — ПЕРЕПИСАТЬ: главный экран (быстрый старт + выбор тем)
  ExerciseSession.tsx                   — NEW: экран сессии (прогресс-бар, навигация, результаты)
  ExerciseMultipleChoice.tsx            — NEW: компонент "выбор варианта"
  ExerciseFillBlank.tsx                 — NEW: компонент "заполни пропуск"
  ExerciseTranslate.tsx                 — NEW: компонент "перевод с русского"
  ExerciseMatching.tsx                  — NEW: компонент "сопоставление"
  TopicSelector.tsx                     — NEW: экран выбора тем с фильтром

src/modules/ExercisesEngine.ts          — NEW: загрузка, формирование сессий, проверка ответов
```

### Изменяемые файлы

```
src/db/index.ts                         — добавить таблицу exerciseProgress
src/types/index.ts                      — добавить типы Exercise, ExerciseProgress, ExerciseType
src/App.tsx                             — добавить роуты /exercises/session, /exercises/topics
```

### Без изменений
VocabularyEngine, SRSEngine, PracticeEngine — упражнения живут отдельно от SRS-системы.

### ExercisesEngine.ts — ключевые функции

- `loadExercises(language)` — загрузка JSON по языку
- `buildSession(userId, level, topicIds?)` — формирование сессии из 10 заданий с приоритетами
- `checkAnswer(exercise, userAnswer)` — проверка ответа в зависимости от типа
- `saveResult(userId, exerciseId, correct)` — сохранение прогресса в Dexie
- `getTopicStats(userId, level)` — статистика по темам для экрана выбора
- `getLevelStats(userId, level)` — агрегированная статистика по уровню
